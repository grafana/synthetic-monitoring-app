# Terraform Configuration Validation

This directory contains scripts and workflows to ensure that the Terraform configuration generated by the Synthetic Monitoring app remains compatible with the official Grafana Terraform provider.

## Problem Statement

The Terraform export functionality in the Synthetic Monitoring app generates configuration files based on TypeScript interfaces. However, these interfaces can drift out of sync with the actual Terraform provider schema, leading to:

- Missing fields in exported configurations
- Incorrect field names or types
- Failed `terraform validate` operations
- Invalid value ranges or types
- Incomplete resource provisioning

## Solution

We've implemented a comprehensive validation system that:

1. **Generates test Terraform configurations** using real production transformation code
2. **Validates them against the provider schema** using `terraform validate`
3. **Runs automatically in CI** with detailed PR feedback
4. **Catches real compatibility issues** before they reach production

## Components

### 1. GitHub Actions Workflow (`.github/workflows/call_validate-terraform.yml`)

**Reusable workflow** using `workflow_call` pattern
- Can be called from other workflows (PR validation, push triggers, manual runs)
- Provides consistent validation across different trigger scenarios
- Uses shared environment setup and commenting logic

The workflow:
- Sets up Node.js (with yarn) and Terraform
- Generates comprehensive test configurations
- Validates them using `terraform validate`
- **Posts detailed PR comments** with validation results and fix instructions
- **Updates existing comments** instead of creating duplicates

### 2. Configuration Generation Script (`generate-test-configs.ts`)

This script:
- Imports real test fixtures from the production codebase
- Uses **actual production transformation functions** (`checkToTF`, `probeToTF`, `sanitizeName`)
- Generates comprehensive test scenarios for all check types and probe types
- Includes alert configurations with proper validation
- Outputs a single `testTerraformConfig.tf.json` file ready for validation

## How It Works

### Validation Process

1. **Generate** comprehensive Terraform configuration from test fixtures
2. **Initialize** Terraform to download the Grafana provider
3. **Validate** configuration against provider schema
4. **Report** detailed results via PR comments (on PRs)

### What It Catches

✅ **Field naming mismatches** 
✅ **Missing required fields** 
✅ **Invalid value ranges** 
✅ **Invalid enum values**
✅ **Type mismatches**
✅ **Schema violations**

### What It Doesn't Test

❌ **Authentication** - Uses no provider credentials  
❌ **API connectivity** - No actual provider API calls  
❌ **Runtime validation** - Provider-specific business logic  
❌ **Resource conflicts** - Name collisions, quota limits  

## Running Validation Locally

### Simple Two-Step Process
```bash
# Generate comprehensive test terraform configuration
yarn build:generate-terraform-test-config

# Validate against provider schema
yarn verify:terraform-test-config
```

### What Gets Validated
The system generates configurations for:
- **All check types**: HTTP, DNS, TCP, Ping, MultiHTTP, Scripted, Traceroute
- **All probe types**: Public, Private, Online, Offline, Scripted-disabled
- **Alert configurations**: For checks that have alerts defined

## Generated Configuration

### Single File Output
```
artifacts/terraform-validation/
└── testTerraformConfig.tf.json    # Comprehensive config with all resources
```

### Configuration Structure

The generated file contains:

```json
{
  "terraform": {
    "required_providers": {
      "grafana": {
        "source": "grafana/grafana",
        "version": "~> 3.0"
      }
    }
  },
  "resource": {
    "grafana_synthetic_monitoring_check": {
      "basic_http": { /* HTTP check config */ },
      "basic_dns": { /* DNS check config */ },
      "basic_tcp": { /* TCP check config */ },
      // ... all check types
    },
    "grafana_synthetic_monitoring_probe": {
      "basic_http_probe": { /* probe config */ },
      // ... all probe types
    },
    "grafana_synthetic_monitoring_check_alerts": {
      "basic_http": { /* alert config for checks with alerts */ }
    }
  }
}
```

**Note:** No provider credentials needed - `terraform validate` only checks schema compatibility.


### Example Validation Results

#### ✅ Success
```bash
terraform validate
Success! The configuration is valid, but there were some validation warnings as shown above.
```

#### ❌ Real Issues Found
```
## Validation Errors

### Error 1
```
Error: Extraneous JSON object property

  on testTerraformConfig.tf.json line 88, in resource.grafana_synthetic_monitoring_check.full_http.settings.http.fail_if_header_matches_regexp[0]:
  88:                 "allowMissing": true

No argument or block type is named "allowMissing". Did you mean "allow_missing"?
```

### Error 2
```
Error: Incorrect attribute value type

  on testTerraformConfig.tf.json line 446, in resource.grafana_synthetic_monitoring_check_alerts.basic_http:
 446:         "alerts": [
 447:           {
 448:             "name": "ProbeFailedExecutionsTooHigh",
 449:             "threshold": 291
 450:           }
 451:         ]

Inappropriate value for attribute "alerts": element 0: attribute "period" is required.
```

## Extending the Validation

### Adding New Check Types
1. Add test fixtures to `src/test/fixtures/checks.ts`
2. Include in the `testCases` array in `generate-test-configs.ts`
3. Test the generated configuration

### Provider Version Updates
1. Update provider version in `generate-test-configs.ts`
2. Run validation to identify new schema requirements
3. Update transformation logic as needed

### Adding New Resource Types
1. Extend the transformation utilities in `src/components/TerraformConfig/`
2. Add corresponding test fixtures
3. Update the generation script to include new resources

## Package Scripts

- `yarn build:generate-terraform-test-config` - Generate comprehensive terraform test configuration
- `yarn verify:terraform-test-config` - Validate the generated terraform configuration
- The validation system integrates with existing development workflows

This validation system ensures terraform export functionality generates configurations that are fully compatible with the official Grafana provider schema, preventing deployment failures and ensuring reliable infrastructure operations. 