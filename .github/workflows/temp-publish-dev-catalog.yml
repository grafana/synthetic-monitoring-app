name: Temp - Publish to Dev Catalog

on:
  push:
    branches:
      - migrate-plugin-cdn

jobs:
  build-and-publish-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Build Environment
        uses: ./.github/actions/setup-env

      - name: Get tokens from Vault
        uses: grafana/shared-workflows/actions/get-vault-secrets@75804962c1ba608148988c1e2dc35fbb0ee21746
        with:
          common_secrets: |
            GRAFANA_ACCESS_POLICY_TOKEN=plugins/sign-plugin-access-policy-token:token
            GCOM_PUBLISH_TOKEN_DEV=plugins/gcom-publish-token:dev

      - name: Build, sign and package plugin
        env:
          GRAFANA_ACCESS_POLICY_TOKEN: ${{ env.GRAFANA_ACCESS_POLICY_TOKEN }}
        run: |
          make build sign package-latest generate-version

      - name: Publish plugin to dev catalog
        env:
          GCOM_PUBLISH_TOKEN: ${{ env.GCOM_PUBLISH_TOKEN_DEV }}
        run: |
          echo "Publishing plugin to dev catalog"
          ./scripts/publish-gcom-dev.sh
