name: Verify Probe API Server Mappings

on:
  workflow_call:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  verify-mappings:
    name: Verify Probe API Server Mappings
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - uses: actions/checkout@v4

      - name: Setup Plugin Environment
        uses: ./.github/actions/setup-env

      - name: Verify probe mappings are up to date
        id: verify-mappings
        continue-on-error: true
        run: |
          # Run the verification and capture output
          if yarn verify:probe-api-mappings; then
            echo "verification_result=success" >> $GITHUB_OUTPUT
          else
            echo "verification_result=failed" >> $GITHUB_OUTPUT
            # Capture the output without yarn wrapper messages
            echo "VERIFICATION_OUTPUT<<EOF" >> $GITHUB_OUTPUT
            yarn --silent verify:probe-api-mappings 2>&1 || true
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if mappings are outdated
        if: steps.verify-mappings.outputs.verification_result == 'failed' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            let message = 'üîÑ **Probe API Server Mappings Verification Failed**\n\n';
            message += 'The `probeAPIServerMappings.json` file appears to be outdated compared to the [Grafana documentation](https://grafana.com/docs/grafana-cloud/testing/synthetic-monitoring/set-up/set-up-private-probes/#add-a-new-probe-in-your-grafana-instance).\n\n';

            const output = ${{ steps.verify-mappings.outputs.VERIFICATION_OUTPUT }};

            if (output && output.trim() !== '') {
              message += '**Verification Output:**\n';
              message += '```\n';
              message += output.trim();
              message += '```\n\n';
            } else {
              message += '‚ö†Ô∏è **Note:** No detailed output captured from verification script.\n\n';
            }

            message += 'To fix this, please run the verification script locally:\n';
            message += '```bash\n';
            message += 'yarn verify:probe-api-mappings\n';
            message += '```\n\n';
            message += 'You may need to update the mappings file to match the current documentation.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Fail the workflow if verification failed
        if: steps.verify-mappings.outputs.verification_result == 'failed'
        run: |
          echo "Probe API server mappings verification failed!"
          exit 1
